description: |
    Run codeception tests for end-to-end testing on a WordPress site.
    Codeception supports unit, wpunit, functional, and acceptance testing.
    This job is based on the Docker image managed at https://github.com/ryanshoover/docker-wp-browser

parameters:
    package_type:
        description: Is this a WordPress plugin or theme
        type: enum
        enum: ["plugin", "theme", "project"]
        default: project
    package_name:
        description: Name of the plugin or theme (directory name)
        type: string
        default: project

executor: wp-browser

steps:
    - run:
          name: Set up composer bin directory
          command: echo 'export PATH=$PATH:~/.composer/vendor/bin' >> $BASH_ENV

    - when:
          condition:
            equal: [ project, << parameters.package_type >> ]
          steps:
            - install:
                production: false
                cache-name: codeception
                include-composer: true
                include-yarn: true
            - compile:
                working_directory: $CIRCLE_WORKING_DIRECTORY
            - run:
                name: Move test files to working directory
                command: |
                    if [ -d vendor/wpengine/dxt-tester/lib/codecept ]; then
                        mv vendor/wpengine/dxt-tester/lib/codecept $CIRCLE_WORKING_DIRECTORY
                    fi

    - when:
          condition:
            equal: [ plugin, << parameters.package_type >> ]
          steps:
            - checkout:
                path: /usr/local/src/config/plugins/<< parameters.package_name >>
            - compile:
                working_directory: /usr/local/src/config/plugins/<< parameters.package_name >>
            - run:
                name: Move test files to working directory
                working_directory: /usr/local/src/config/plugins/<< parameters.package_name >>
                command: |
                    mv vendor/wpengine/dxt-tester/lib/codecept $CIRCLE_WORKING_DIRECTORY
                    mv tests $CIRCLE_WORKING_DIRECTORY

    - when:
          condition:
            equal: [ theme, << parameters.package_type >> ]
          steps:
            - checkout:
                path: /usr/local/src/config/themes/<< parameters.package_name >>
            - compile:
                working_directory: /usr/local/src/config/themes/<< parameters.package_name >>
            - run:
                name: Move test files to working directory
                working_directory: /usr/local/src/config/themes/<< parameters.package_name >>
                command: |
                    mv vendor/wpengine/dxt-tester/lib/codecept $CIRCLE_WORKING_DIRECTORY
                    mv tests $CIRCLE_WORKING_DIRECTORY

    - run:
          name: Make sure WordPress is loaded
          command: entrypoint.sh

    - run:
          name: Set up env variables for codeception symlinking
          command: |
              echo 'export SYMLINK_YML=codeception.<< parameters.package_type >>.yml' >> $BASH_ENV
              echo 'export SYMLINK_FOLDER=<< parameters.package_name >>' >> $BASH_ENV
              source $BASH_ENV

    - run:
          name: Run Codeception acceptance tests
          command: codecept run acceptance --xml="$CIRCLE_WORKING_DIRECTORY/test-results/acceptance/results.xml"
    - run:
          name: Run Codeception functional tests
          command: codecept run functional --xml="$CIRCLE_WORKING_DIRECTORY/test-results/functional/results.xml"
    - run:
          name: Run Codeception unit tests
          command: codecept run unit --xml="$CIRCLE_WORKING_DIRECTORY/test-results/unit/results.xml"
    - run:
          name: Run Codeception wpunit tests
          command: codecept run wpunit --xml="$CIRCLE_WORKING_DIRECTORY/test-results/wpunit/results.xml"

    - store_test_results:
          path: test-results

    - store_artifacts:
          path: tests/_output
