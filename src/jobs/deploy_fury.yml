description: |
    Deploy a PHP, Node, or Ruby package to a Gemfury repository. Designed to be run on new GitHub releases.

executor: base

parameters:
    user:
        description: Gemfury user or team name
        type: env_var_name
        default: GEMFURY_USER
    token:
        description: Gemfury PUSH token
        type: env_var_name
        default: GEMFURY_TOKEN_PUSH
    project:
        description: Project name
        type: env_var_name
        default: CIRCLE_PROJECT_REPONAME

steps:
    - attach_workspace:
          at: .

    - run:
          name: Check out master branch
          command: git checkout master

    - run:
          name: Make sure we have production-only composer dependencies
          command: composer install --no-dev --no-ansi --no-interaction --optimize-autoloader --no-progress --prefer-dist

    - run:
          name: Make sure we have production-only yarn dependencies
          command: yarn install --prod --emoji false --no-progress --non-interactive

    - run:
          name: Add Fury git repo
          command: git remote add fury "https://$<< parameters.user >>:$<< parameters.token >>@git.fury.io/$<< parameters.user >>/$<< parameters.project >>.git"

    - gitignoreswap:
          gitignore_type: package

    - run:
          name: Rewrite tag with compiled files
          command: |
              if [[ -z "${CIRCLE_TAG}" ]]; then
                git tag -f -m "Fury deployment compiled" "$CIRCLE_TAG"
              fi

    - deploy:
          name: Deploy to GemFury
          command: git push fury master --tags
