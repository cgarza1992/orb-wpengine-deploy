description: |
    General setup command. Handles cache, git checkout,
    composer install, and yarn install.

parameters:
    production:
        description: Is this a production build?
        type: boolean
        default: false
    include-composer:
        description: Should composer skip dependencies?
        type: boolean
        default: false
    include-yarn:
        description: Should yarn skip dependencies?
        type: boolean
        default: false
    working-directory:
         type: env_var_name
         default: CIRCLE_WORKING_DIRECTORY


steps:
    - checkout

    # See https://discuss.circleci.com/t/circle-working-directory-doesnt-expand/17007
    - run:
            name: "Fix relative working directories"
            command: echo "<< parameters.working-directory >>=${<< parameters.working-directory >>/#\~/$HOME}" >> $BASH_ENV

    - when:
          condition: << parameters.include-composer >>
          steps:
              - restore_cache:
                    keys:
                        - composer-<< parameters.production >>-{{ .Environment.CACHE_VERSION }}-{{ checksum "composer.lock" }}
              - run:
                    name: Install composer dependencies
                    command: |
                        cd $<< parameters.working-directory >>
                        composer install <<# parameters.production >> --no-dev <</ parameters.production >> --no-ansi --no-interaction --optimize-autoloader --no-progress --prefer-dist
              - save_cache:
                    paths:
                        - "./vendor"
                    key: composer-<< parameters.production >>-{{ .Environment.CACHE_VERSION }}-{{ checksum "composer.lock" }}

    - when:
          condition: << parameters.include-yarn >>
          steps:
              - restore_cache:
                    keys:
                        - yarn-<< parameters.production >>-{{ .Environment.CACHE_VERSION }}-{{ checksum "yarn.lock" }}
              - run:
                    name: Add Gemfury registry
                    command: npm config set @dxt:registry "https://npm.fury.io/wpedxt/"
              - run:
                    name: Add authentication to Gemfury
                    command: |
                        cd $<< parameters.working-directory >>
                        echo "//npm.fury.io/wpedxt/:_authToken=${FURY_AUTH}" > .npmrc
              - run:
                    name: Install node dependencies
                    command: |
                        cd $<< parameters.working-directory >>
                        yarn install <<# parameters.production >> --production <</ parameters.production >> --emoji false --no-progress --non-interactive
              - save_cache:
                    paths:
                        - "$<< parameters.working-directory >>/node_modules"
                    key: yarn-<< parameters.production >>-{{ .Environment.CACHE_VERSION }}-{{ checksum "yarn.lock" }}
              - run:
                    name: Build compiled files
                    command: |
                        cd $<< parameters.working-directory >>
                        if jq '.scripts.build' package.json; then
                            yarn run build
                        fi

