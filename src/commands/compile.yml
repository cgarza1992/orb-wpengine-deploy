description: |
    Compiles a package or project root. Installs composer, installs yarn, and runs yarn build.

parameters:
    working_directory:
        description: Working directory to run the build in.
        type: string

steps:
    - run:
        name: Install Composer
        command: |
            cd << parameters.working_directory >> || $CIRCLE_WORKING_DIRECTORY
            [ -f composer.json ] && \
            composer install --no-ansi --no-interaction --optimize-autoloader --no-progress --prefer-dist

    - run:
        name: Set up Gemfury
        command: |
            cd << parameters.working_directory >> || $CIRCLE_WORKING_DIRECTORY
            if [ -f package.json ]; then
                npm config set @dxt:registry https://npm.fury.io/wpedxt/
                echo "//npm.fury.io/wpedxt/:_authToken=${FURY_AUTH}" > .npmrc
            fi

    - run:
        name: Install Yarn
        command: |
            cd << parameters.working_directory >> || $CIRCLE_WORKING_DIRECTORY
            if [ -f package.json ]; then
                yarn install --emoji false --no-progress --non-interactive
            fi

    - run:
        name: Yarn build
        command: |
            cd << parameters.working_directory >> || $CIRCLE_WORKING_DIRECTORY
            if yarn run --non-interactive | grep -e "- build"; then
                yarn run build
            fi
